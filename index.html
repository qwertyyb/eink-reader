<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no,viewport-fit=cover">
  <title>EInk Reader</title>
  <link rel="manifest" href="./manifest.json">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="./css/components/index.css">
  <style>
    * {
      padding: 0;
      margin: 0;
      color: #000;
    }
    html, body, #app, .page-container, .content-wrapper {
      height: 100%;
    }
    html, body, .page-container {
      width: 100%;
      background-color: #fff;
    }
    /* dark mode start */
    html.dark-mode {
      filter: invert(1) hue-rotate(180deg)
    }
    /* dark mode end */


    .page-container {
      position: relative;
    }
  </style>
</head>
<body>
  <div id="app">
    <router-view></router-view>
  </div>
  <div style="display: none" id="components">
    <div class="page-container shelf-page route-index">
      <div class="shelf-wrapper">
        <div class="header">
          <span id="import-file"
            @click="importLocalFile"
            class="material-icons">add</span>
        </div>
        <div class="self">
          <div class="book-list">
            <div class="book-item"
              v-for="(book, index) in bookList"
              :key="index"
              :data-book-id="book.id"
              @click="toReadBook(book, index, bookList)">
              <img :src="book.cover" class="book-cover"/>
              <div class="book-title">
                <span class="material-icons status-icon" v-if="book.downloaded">check_circle</span>
                <span>{{ book.title }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="type-tabs">
        <div class="tab-item" id="local-books" @click="changeTab('local')">
          <span class="material-icons">menu_book</span>
          本地
        </div>
        <div class="tab-item center" @click="toLastReadBook" v-if="lastReadBook">
          <span class="material-icons">book</span>
        </div>
        <div class="tab-item" id="online-books" @click="changeTab('online')">
          <span class="material-icons">cloud</span>
          在线
        </div>
      </div>
    </div>

    <div class="page-container detail-page route-book">
      <div class="navigator-wrapper" v-show="panelVisible">
        <div class="navigator">
          <div id="back-to-index" class="material-icons"
            @click="$router.replace('/')">arrow_back</div>
        </div>
      </div>
      <catalog-dialog :catalog="catalog"
        :selected-item="curCatalogItem"
        :visible="visiblePanel === 'catalog'"
        @to-catalog-item="toCatalogItem"
        @close="visiblePanel=null"></catalog-dialog>
      <div class="content-wrapper" ref="contentWrapper" @scroll="scrollHandler">
        <div class="content" :data-font="settings.fontFamily"
          :style="{fontSize: settings.fontSize + 'px'}"
          :class="{ column: isBooxLeaf }"
          ref="content"
          v-html="content">
        </div>
      </div>
      <div class="control-wrapper" v-show="panelVisible">
        <div class="control">
          <div class="control-item" data-control="catalog"
            @click="actionHandler('catalog')">
            <div class="control-icon material-icons">menu</div>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="autoPlay"
            @click="actionHandler('autoPlay')">
            <div class="control-icon material-icons">{{ controlState.autoPlay ? 'pause' : 'play_arrow' }}</div>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="readSpeak" @click="actionHandler('readSpeak')">
            <div class="control-icon material-icons">{{ controlState.readSpeak ? 'pause_circle' : 'play_circle' }}</div>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="font" @click="visiblePanel='font'">
            <span class="material-icons">text_format</span>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="darkMode" @click="actionHandler('darkMode')">
            <span class="material-icons">{{ controlState.darkMode ? 'light_mode' : 'dark_mode' }}</span>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="fullscreen" @click="actionHandler('fullscreen')">
            <span class="material-icons">{{ controlState.fullscreen ? 'close_fullscreen' : 'fullscreen' }}</span>
            <div class="control-label"></div>
          </div>

          <div class="control-panel play-panel" data-target-control="autoPlay" v-if="visiblePanel === 'autoPlay'">
            <div class="speed">
              <button class="material-icons speed-dec" data-action="dec" @click="changeAutoPlayDuration(settings.autoPlayDuration - 1)">
                remove
              </button>
              <span class="speed-value">{{ settings.autoPlayDuration }}</span>
              <button class="material-icons speed-inc" data-action="inc" @click="changeAutoPlayDuration(settings.autoPlayDuration + 1)">
                add
              </button>
            </div>
          </div>

          <div class="control-panel font-panel" data-target-control="font" v-if="visiblePanel === 'font'">
            <div class="font-family">
              <select name="font" v-model="settings.fontFamily">
                <option value="SYST">思源宋体</option>
                <option value="FZSS" selected>方正书宋</option>
                <option value="FZFS">方正仿宋</option>
                <option value="FZHT">方正黑体</option>
                <option value="FZKT">方正楷体</option>
              </select>
            </div>
            <div class="font-size">
              <button class="material-icons text-dec" @click="settings.fontSize -= 1">
                  text_decrease
              </button>
              <span class="text-size">{{ settings.fontSize }}</span>
              <button class="material-icons text-inc" @click="settings.fontSize += 1">
                  text_increase
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div class="catalog" v-show="visible">
      <div class="mask" @click="$emit('close')"></div>
      <div class="catalog-content">
        <virtual-list
          class="catalog-content-wrapper"
          data-key="id"
          :data-sources="catalog"
          ref="catalog"
          :estimate-size="48">
          <template #="{ source, index }">
            <div class="catalog-item"
              @click="$emit('to-catalog-item', source, index)"
              :class="{active: selectedItem && `${source.id}` === `${selectedItem.id}`}"
              :data-catalog-id="source.id">
              <div class="catalog-label">{{ source.title }}</div>
            </div>
          </template>
        </virtual-list>
      </div>
    </div>
  </div>
  <script src="./js/lib/vconsole.min.js"></script>
  <script src="./js/lib/zepto.min.js"></script>
  <script src="./js/lib/hammer.min.js"></script>
  <script type="importmap">
    { "imports": {
        "vue":               "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
        "vue-router":        "https://unpkg.com/vue-router@4/dist/vue-router.esm-browser.js",
        "@vue/devtools-api": "https://unpkg.com/@vue/devtools-api@6.4.5/lib/esm/index.js"
    } }
  </script>
  <script type="module" src="./index.js">

    // if ('serviceWorker' in navigator && new URL(location.href).searchParams.get('no-cache') !== '1') {
    //   navigator.serviceWorker.register('sw.js')
    //     .then(reg => {
    //       console.log('service worker register successfully: ', reg)
    //     })
    //     .catch(err => {
    //       console.error('service worker register failed: ', err)
    //     })

    //   const controller = {
    //     prompt: window.prompt,
    //     toast: (...args) => toast.show(...args)
    //   }
    //   navigator.serviceWorker.addEventListener('message', async event => {
    //     const { type, method, payload, callback } = event
    //     if (type === 'invoke') {
    //       let result = await controller[method](...payload)
    //       return navigator.serviceWorker.postMessage({
    //         type: 'callback',
    //         callback: callback,
    //         result: result
    //       })
    //     }
    //   })
    //   navigator.serviceWorker.addEventListener('controllerchange', () => {
    //     toast.show('已更新, 刷新页面后可应用')
    //   })
    // }

    // const jsonp = (data) => {
    //   return new Promise((resolve, reject) => {
    //     $.ajax({
    //       url: localStorage.getItem('proxyUrl'),
    //       dataType: 'jsonp',
    //       data: {
    //         format: 'string',
    //         charset: 'gbk',
    //         ...data
    //       },
    //       success: resolve,
    //       error: (xhr, textStatus, errMessage) => {
    //         alert('获取数据失败')
    //         if (window.confirm('清除代理URL?')) {
    //           localStorage.removeItem('proxyUrl')
    //         }
    //         reject(new Error('失败'))
    //       }
    //     })
    //   })
    // }
  </script>
</body>
</html>