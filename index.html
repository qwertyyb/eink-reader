<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eink Reader</title>
  <link rel="manifest" href="./manifest.json">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="./css/components/virtual-scroll-list.css">
  <style>
    * {
      padding: 0;
      margin: 0;
      color: #000;
    }
    html, body, .page-container {
      width: 100%;
      height: 100%;
      background-color: #fff;
    }
    /* dark mode start */
    html.dark-mode {
      filter: invert(1) hue-rotate(180deg)
    }
    /* dark mode end */


    .page-container {
      position: relative;
    }
    .page-container.shelf-page .type-tabs {
      display: flex;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 54px;
      border-top: 1px solid #bbb;
    }
    .page-container.shelf-page .type-tabs .tab-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .page-container.shelf-page .type-tabs .tab-item.center {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin-top: -60px;
      background: #fff;
      border: 1px solid #000;
      min-width: 100px;
      min-height: 100px;
      max-width: 100px;
      max-height: 100px;
    }
    .page-container.shelf-page .type-tabs .tab-item.center .material-icons {
      font-size: 48px;
    }
    .page-container.shelf-page .book-list {
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, 140px);
      column-gap: 20px;
      row-gap: 20px;
    }
    .page-container.shelf-page .book-item .book-cover {
      box-shadow: 3px 3px 3px rgba(0, 0, 0, 0.2);
      width: 120px;
      height: 160px;
    }
    .page-container.shelf-page .shelf-wrapper .header {
      height: 48px;
      border-bottom: 1px solid #bbb;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 20px;
    }
    .page-container.shelf-page .shelf-wrapper .header #import-file {
      font-size: 32px;
    }
    .book-item .book-cover {
      width: 100%;
      height: auto;
    }
    .book-item .book-title {
      text-align: center;
      width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .navigator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      width: 100%;
      display: flex;
      box-sizing: border-box;
      align-items: center;
      padding: 0 20px;
      background: #fff;
      border-bottom: 1px solid #000;
      z-index: 10;
    }
    .navigator #back-to-index {
      font-size: 32px;
    }
    .catalog-content {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      border-right: 1px solid #000;
      width: 70vw;
      max-width: 300px;
      background-color: #fff;
      z-index: 10;
      max-height: 100vh;
      overflow: auto;
      content-visibility: auto;
    }
    .catalog-content > div {
      box-sizing: border-box;
    }
    .catalog-item {
      padding: 0 10px;
      border-bottom: 1px solid #000;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      height: 48px;
    }
    .catalog-item.active {
      color: #fff;
      background: #000;
    }
    .catalog-item.active .catalog-label {
      color: #fff;
    }
    .control {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 6;
      height: 60px;
      background-color: #fff;
      border-top: 1px solid #000;
      text-align: center;
    }
    .control .material-icons {
      font-size: 32px;
    }
    .mask {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9;
    }
    .content-wrapper {
      width: 100%;
      height: 100%;
      overflow: auto;
      max-height: 100vh;
    }
    .content {
      box-sizing: border-box;
      height: 100%;
      margin-left: 20px;
      margin-right: 20px;
      width: calc(100vw - 40px);
    }
    .content.column {
      margin-top: 20px;
      margin-bottom: 20px;
      column-gap: 0;
      column-width: calc(100vw - 40px);
      overflow: hidden;
      height: calc(100% - 40px);
    }
    .content .placeholder {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      width: 100%;
      z-index: 4;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .control .control-panel {
      position: absolute;
      left: 0;
      bottom: 100%;
      right: 0;
      background: #fff;
      padding: 30px 0;
      border-top: 1px solid #000;
      display: none;
    }
    .control .control-panel.font-panel {
      display: flex;
      font-size: 20px;
      justify-content: space-around;
    }
    .control-panel.font-panel .font-family select {
      border: 1px solid #000;
      border-radius: 5px;
      padding: 4px 8px;
      font-size: 22px;
    }
    .control-panel.font-panel .font-size {
      display: flex;
      align-items: center;
    }
    .control-panel.font-panel .font-size .text-size {
      padding: 0 20px;
    }
    .control-panel.font-panel .font-size button {
      border: 1px solid #000;
      border-radius: 999px;
      font-size: 24px;
      padding: 6px;
    }

    .control-panel.play-panel {
      display: flex;
      justify-content: space-around;
    }
    .control-panel.play-panel button {
      border: 1px solid #000;
      border-radius: 999px;
      font-size: 24px;
      padding: 6px;
    }
    .control-panel.play-panel .speed {
      width: 90%;
      display: flex;
      align-items: center;
      justify-content: space-around;
    }
  </style>
  <style id="theme">
    @font-face {
      font-family: "SourceHansSerifCN-VF";
      src: url("./css/fonts/SourceHanSerifCN-VF.otf.woff2") format("woff2"), url("./css/fonts/SourceHanSerifCN-VF.otf") format("otf");
    }
    @font-face {
      font-family: "FZKTSC";
      src: url("./css/fonts/FZKTSC.ttf") format("truetype");
    }
    @font-face {
      font-family: "FZFSSC";
      src: url("./css/fonts/FZFSSC.ttf") format("truetype");
    }
    @font-face {
      font-family: "FZSSSC";
      src: url("./css/fonts/FZSSSC.ttf") format("truetype");
    }
    @font-face {
      font-family: "FZHTSC";
      src: url("./css/fonts/FZHTSC.ttf") format("truetype");
    }
    .content {
      line-height: 2;
      font-size: 24px;
      font-weight: bold;
      color: black;
      user-select: text;
    }
    .content > p {
      text-indent: 2em;
      letter-spacing: 1px;
    }
    .content > p.reading span {
      background: yellow;
    }
    [data-font="SYST"] {
      font-family: "SourceHansSerifCN-VF";
    }
    [data-font="FZKT"] {
      font-family: "FZKTSC";
    }
    [data-font="FZFS"] {
      font-family: "FZFSSC";
    }
    [data-font="FZSS"] {
      font-family: "FZSSSC";
    }
    [data-font="FZHT"] {
      font-family: "FZHTSC";
    }
  </style>
</head>
<body>
  <div id="app">
    <router-view></router-view>
  </div>
  <div style="display: none">
    <div class="page-container shelf-page route-index">
      <div class="shelf-wrapper">
        <div class="header">
          <span id="import-file"
            @click="importLocalFile"
            class="material-icons">add</span>
        </div>
        <div class="self">
          <div class="book-list">
            <div class="book-item"
              v-for="(book, index) in bookList"
              :key="index"
              :data-book-id="book.id"
              @click="toWatchBook(book, index, bookList)">
              <img :src="book.cover" class="book-cover"/>
              <div class="book-title">{{ book.title }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="type-tabs">
        <div class="tab-item" id="local-books" @click="changeTab('local')">
          <span class="material-icons">menu_book</span>
          本地
        </div>
        <div class="tab-item center">
          <span class="material-icons">book</span>
        </div>
        <div class="tab-item" id="online-books" @click="changeTab('online')">
          <span class="material-icons">cloud</span>
          在线
        </div>
      </div>
    </div>

    <div class="page-container detail-page route-book">
      <div class="navigator-wrapper" v-show="panelVisible">
        <div class="navigator">
          <div id="back-to-index" class="material-icons">arrow_back</div>
        </div>
      </div>
      <div class="catalog" v-if="visiblePanel === 'catalog'">
        <div class="mask" @click="visiblePanel=null"></div>
        <div class="catalog-content">
          <virtual-scroll-list :list="catalog" v-slot="slotProps">
            <div class="catalog-item"
              @click="toCatalogItem(slotProps.item, slotProps.index)"
              :class="{active: curCatalogItem && slotProps.item.id === curCatalogItem.id}"
              :data-catalog-id="slotProps.item.id">
              <div class="catalog-label">{{ slotProps.item.title }}</div>
            </div>
          </virtual-scroll-list>
        </div>
      </div>
      <div class="content-wrapper" ref="contentWrapper" style="opacity: 0">
        <div class="content" :data-font="settings.fontFamily"
          :class="{ column: isBooxLeaf }"
          ref="content"
          v-html="content">
        </div>
      </div>
      <div class="control-wrapper" v-show="panelVisible">
        <div class="control">
          <div class="control-item" data-control="catalog"
            @click="visiblePanel='catalog'">
            <div class="control-icon material-icons">menu</div>
            <div class="control-label">目录</div>
          </div>
          <div class="control-item" data-control="autoPlay"
            @click="actionHandler('autoPlay')">
            <div class="control-icon material-icons">{{ controlState.autoPlay ? 'pause' : 'play_arrow' }}</div>
            <div class="control-label">自动翻页</div>
          </div>
          <div class="control-item" data-control="readSpeak" @click="actionHandler('readSpeak')">
            <div class="control-icon material-icons">{{ controlState.readSpeak ? 'pause_circle' : 'play_circle' }}</div>
            <div class="control-label">朗读</div>
          </div>
          <div class="control-item" data-control="font" @click="visiblePanel='font'">
            <span class="material-icons">text_format</span>
            <div class="control-label">字体</div>
          </div>
          <div class="control-item" data-control="darkMode" @click="actionHandler('darkMode')">
            <span class="material-icons">{{ controlState.darkMode ? 'light_mode' : 'dark_mode' }}</span>
            <div class="control-label">{{ controlState.darkMode ? '白天' : '夜间' }}</div>
          </div>
          <div class="control-item" data-control="fullscreen" @click="actionHandler('fullscreen')">
            <span class="material-icons">{{ controlState.fullscreen ? 'close_fullscreen' : 'fullscreen' }}</span>
            <div class="control-label">{{ controlState.fullscreen ? '退出全屏' : '全屏' }}</div>
          </div>

          <div class="control-panel play-panel" data-target-control="autoPlay" v-if="visiblePanel === 'autoPlay'">
            <div class="speed">
              <button class="material-icons speed-dec" data-action="dec" @click="changeAutoPlayDuration(settings.duration - 1)">
                remove
              </button>
              <span class="speed-value">{{ settings.autoPlayDuration }}</span>
              <button class="material-icons speed-inc" data-action="inc" @click="changeAutoPlayDuration(settings.duration + 1)">
                add
              </button>
            </div>
          </div>

          <div class="control-panel font-panel" data-target-control="font" v-if="visiblePanel === 'font'">
            <div class="font-family">
              <select name="font" v-model="settings.fontFamily">
                <option value="SYST">思源宋体</option>
                <option value="FZSS" selected>方正书宋</option>
                <option value="FZFS">方正仿宋</option>
                <option value="FZHT">方正黑体</option>
                <option value="FZKT">方正楷体</option>
              </select>
            </div>
            <div class="font-size">
              <button class="material-icons text-dec" @click="settings.fontSize -= 1">
                  text_decrease
              </button>
              <span class="text-size">{{ settings.fontSize }}</span>
              <button class="material-icons text-inc" @click="settings.fontSize += 1">
                  text_increase
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="./js/lib/vconsole.min.js"></script>
  <script src="./js/lib/zepto.min.js"></script>
  <script src="./js/lib/hammer.min.js"></script>
  <script src="./js/vlist.js"></script>
  <script type="importmap">
    { "imports": {
        "vue":               "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
        "vue-router":        "https://unpkg.com/vue-router@4/dist/vue-router.esm-browser.js",
        "@vue/devtools-api": "https://unpkg.com/@vue/devtools-api@6.4.5/lib/esm/index.js"
    } }
  </script>
  <script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
    import { createRouter, createWebHashHistory } from 'https://unpkg.com/vue-router@4/dist/vue-router.esm-browser.js'
    import { parseAndStoreFile, services } from './index.js'
    import { createAutoPlay, darkMode, fullscreen, readSpeak } from './js/actions/index.js'
    import { getSettings, saveAllSettings } from './js/utils/settings.js'
    import { env } from './js/utils/env.js'
    import VirtualScrollList from './js/components/virtual-scroll-list.js'

    const showToast = (msg, duration = 1500) => {
      const toastEl = $(`<div style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:100;border:1px solid #000;border-radius:4px;padding:4px 10px;background:#000;color:#fff;">${msg}</div>`)
      const body = $('body').append(toastEl)
      setTimeout(() => {
        toastEl.remove()
      }, duration)
    }

    const IndexPage = {
      template: document.querySelector('.route-index').outerHTML,
      data() {
        return {
          curTab: 'local', // local | online
          bookList: [],
          curBook: null,
          curCatalogItem: null,
        }
      },
      created() {
        this.refreshBookList()
      },
      methods: {
        async refreshBookList() {
          const bookList = await services[this.curTab].getBookList()
          this.bookList = bookList
        },
        changeTab(tab) {
          this.curTab = tab
          this.refreshBookList()
        },
        importLocalFile() {
          const input = document.createElement('input')
          input.type = 'file'
          input.accept = '*.txt'
          input.addEventListener('change', async e => {
            const [file] = input.files || []
            if(!file) return
            await parseAndStoreFile(file)
            this.refreshBookList()
          })
          input.style.display = 'none'
          input.click()
        },
        toWatchBook(book, index, bookList) {
          this.$router.push({
            name: 'book',
            params: {
              server: this.curTab,
              id: book.id
            }
          })
        }
      }
    }

    const BookPage = {
      template: document.querySelector('.route-book').outerHTML,
      props: {
        server: String,
        id: [String, Number]
      },
      components: {
        VirtualScrollList
      },
      data() {
        return {
          book: null,
          catalog: [],
          content: '<div class="placeholder">正在加载</div>',
          curCatalogItem: {},
          panelVisible: false,
          visiblePanel: null,

          controlState: {
            fullscreen: false,
            darkMode: false,
            readSpeak: false,
            autoPlay: false
          },

          settings: getSettings(),
          isBooxLeaf: env.isBooxLeaf()
        }
      },
      watch: {
        settings: {
          deep: true,
          handler() {
            saveAllSettings(this.settings)
          }
        }
      },
      created() {
        this.fetchBook()
      },
      mounted() {
        this.initHammer()
        this.initAction()
      },
      beforeUnmount() {
        this.hammer && this.hammer.destroy()
        this.actions.autoPlay.stop()
        fullscreen.exit()
        darkMode.exit()
      },
      methods: {
        async fetchBook() {
          const book = await services[this.server].getBookList().then(bookList => bookList.find(book => `${book.id}` === `${this.id}`))
          if (!book) {
            return showToast(`获取book失败: ${this.server}/${this.id}`)
          }
          const { catalog } = await services[this.server].getCatalog(book)
          if (!catalog) {
            return showToast(`获取目录失败: ${this.server}/${this.id}`)
          }
          this.catalog = catalog
          this.book = book
          const first = catalog[0]
          if (first) {
            this.toCatalogItem(first, 0, catalog)
          }
        },
        async toCatalogItem(item, index, catalog) {
          this.curCatalogItem = item
          const { content } = await services[this.server].getContent(item, this.book)
          this.content = content
          this.visiblePanel = null
          this.panelVisible = false
          this.$refs.content.scrollTop = 0
          this.$refs.content.scrollLeft = 0
        },
        changeAutoPlayDuration(duration) {
          this.settings.autoPlayDuration = duration
          this.actions.autoPlay.updateInterval(duration)
        },
        initHammer() {
          const contentTapHandler = (event) => {
            if (env.isBooxLeaf) {
              // 左、中、右
              const { x } = event.center
              const centerLeft = window.innerWidth / 3
              const centerRight = 2 * centerLeft
              const isLeft = x < centerLeft
              const isRight = x > centerRight
              if (isLeft) return prevPage()
              if (isRight) return nextPage()
            }
            if (this.actions.autoPlay.isPlaying()) {
              this.visiblePanel = 'autoPlay'
            }
            this.panelVisible = !this.panelVisible
          }
          const hammer = new Hammer(this.$refs.contentWrapper)
          if (env.isBooxLeaf) {
            hammer.on('swipeleft', () => nextPage())
            hammer.on('swiperight', () => prevPage())
          }
          hammer.on('tap', contentTapHandler)
          this.hammer = hammer
        },
        initAction() {
          this.actions = {
            autoPlay: createAutoPlay({
              nextPage: () => this.pageHandler(direction),
              scrollVertical: () => this.$refs.contentWrapper.scrollTop += 1
            })
          }
        },
        async actionHandler(control) {
          // action: readSpeak | darkMode | fullscreen | autoPlay
          if (control === 'fullscreen') {
            await fullscreen.toggle()
            this.controlState.fullscreen = fullscreen.isActivated()
          }
          if (control === 'darkMode') {
            darkMode.toggle()
            this.controlState.darkMode = darkMode.isActivated
          }
          if (control === 'readSpeak') {
            readSpeak.toggle()
            this.controlState.readSpeak = readSpeak.isSpeaking()
          } else if (control === 'autoPlay') {
            this.visiblePanel = 'autoPlay'
            this.actions.autoPlay.toggle()
            this.controlState.autoPlay = this.actions.autoPlay.isPlaying()
          }
        },
        pageHandler (direction) {
          const content = this.$refs.content
          const pageWidth = content.offsetWidth
          const curPage = Math.round(content.scrollLeft / pageWidth)
          const originScroll = content.scrollLeft;
          if (direction === 'prev') {
            content.scrollLeft = (curPage - 1) * pageWidth;
            if (content.scrollLeft === originScroll) {
              showToast('已是第一页')
            }
          } else if (direction === 'next') {
            content.scrollLeft = (curPage + 1) * pageWidth;
            if (content.scrollLeft === originScroll) {
              showToast('已是最后一页')
            }
          }
        }
      }
    }

    const routes = [
      { path: '/', name: 'home', component: IndexPage },
      { path: '/book/:server/:id', name: 'book', component: BookPage, props: true },
    ]

    const router = createRouter({
      history: createWebHashHistory(),
      routes,
    })

    const app = createApp({})

    app.use(router)

    app.mount('#app')

    if ('serviceWorker' in navigator && new URL(location.href).searchParams.get('no-cache') !== '1') {
      navigator.serviceWorker.register('sw.js')
        .then(reg => {
          console.log('service worker register successfully: ', reg)
        })
        .catch(err => {
          console.error('service worker register failed: ', err)
        })

      const controller = {
        prompt: window.prompt,
        toast: (...args) => toast.show(...args)
      }
      navigator.serviceWorker.addEventListener('message', async event => {
        const { type, method, payload, callback } = event
        if (type === 'invoke') {
          let result = await controller[method](...payload)
          return navigator.serviceWorker.postMessage({
            type: 'callback',
            callback: callback,
            result: result
          })
        }
      })
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        toast.show('已更新, 刷新页面后可应用')
      })
    }

    const jsonp = (data) => {
      return new Promise((resolve, reject) => {
        $.ajax({
          url: localStorage.getItem('proxyUrl'),
          dataType: 'jsonp',
          data: {
            format: 'string',
            charset: 'gbk',
            ...data
          },
          success: resolve,
          error: (xhr, textStatus, errMessage) => {
            alert('获取数据失败')
            if (window.confirm('清除代理URL?')) {
              localStorage.removeItem('proxyUrl')
            }
            reject(new Error('失败'))
          }
        })
      })
    }


    window.onload = () => {
      if (!localStorage.getItem('proxyUrl')) {
        const input = window.prompt('请输入proxyUrl')
        if (!input) return;
        localStorage.setItem('proxyUrl', input)
      }
      if (!localStorage.getItem('proxyUrl')) {
        return
      }
    }
  </script>
</body>
</html>