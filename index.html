<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, initial-scale=1.0, user-scalable=no,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="referrer" content="unsafe-url">
  <title>EInk Reader</title>
  <link rel="manifest" href="./manifest.json">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="./css/components/index.css">
  <style>
    * {
      padding: 0;
      margin: 0;
      color: #000;
    }
    html, body {
      height: 100vh;
      overflow: hidden;
    }
    html, body, .page-container {
      width: 100%;
      background-color: #fff;
    }
    /* dark mode start */
    html.dark-mode {
      filter: invert(1) hue-rotate(180deg)
    }
    /* dark mode end */


    .page-container {
      position: relative;
    }
  </style>
</head>
<body>
  <div id="app">
    <router-view></router-view>
  </div>
  <div style="display: none" id="components">
    <div class="page-container shelf-page route-index">
      <div class="shelf-wrapper">
        <div class="header">
          <span id="import-file"
            @click="importLocalFile"
            class="material-icons">add</span>
        </div>
        <div class="self">
          <div class="book-list">
            <div class="book-item"
              v-for="(book, index) in bookList"
              :key="index"
              :data-book-id="book.id"
              @click="toReadBook(book, index, bookList)">
              <div class="book-cover">
                {{ book.title }}
                <div class="download-progress-size" v-if="!book.downloaded && book.total && book.progress">
                  {{ book.fProgress }}
                </div>
                <div class="download-progress-percent" v-if="!book.downloaded && book.total && book.progress">
                  ({{ Math.round(book.progress/book.total * 100) + '%' }})
                </div>
              </div>
              <div class="book-title">
                <span class="material-icons status-icon" v-if="book.downloaded">check_circle</span>
                <span>{{ book.title }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="type-tabs">
        <div class="tab-item" id="local-books" @click="changeTab('local')">
          <span class="material-icons">menu_book</span>
          本地
        </div>
        <div class="tab-item center" @click="toLastReadBook" v-if="lastReadBook">
          <span class="material-icons">book</span>
        </div>
        <div class="tab-item" id="online-books" @click="changeTab('online')">
          <span class="material-icons">cloud</span>
          在线
        </div>
      </div>
    </div>

    <div class="page-container detail-page route-book">
      <div class="navigator-wrapper" v-show="panelVisible">
        <div class="navigator">
          <div id="back-to-index" class="material-icons"
            @click="$router.replace('/')">arrow_back</div>
        </div>
      </div>
      <catalog-dialog :catalog="chapterList"
        :selected-item="chapter"
        :visible="visiblePanel === 'catalog'"
        @to-catalog-item="toCatalogItem"
        @close="visiblePanel=null"></catalog-dialog>
      <div class="content-wrapper" ref="contentWrapper" @scroll="scrollHandler">
        <div class="content" :data-font="settings.fontFamily"
          :style="{
            fontSize: settings.fontSize + 'px',
            fontWeight: settings.bold ? 'bold' : 'normal'
          }"
          :class="{ column: isBooxLeaf }"
          ref="content"
          @scroll="hScrollHandler"
          v-html="content">
        </div>
      </div>
      <div class="control-wrapper" v-show="panelVisible">
        <div class="control">
          <div class="control-item" data-control="catalog"
            @click="actionHandler('catalog')">
            <div class="control-icon material-icons">menu</div>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="autoPlay"
            @click="actionHandler('autoPlay')">
            <div class="control-icon material-icons">{{ controlState.autoPlay ? 'pause' : 'play_arrow' }}</div>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="readSpeak" @click="actionHandler('readSpeak')">
            <div class="control-icon material-icons">{{ controlState.readSpeak ? 'pause_circle' : 'play_circle' }}</div>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="font" @click="visiblePanel='font'">
            <span class="material-icons">text_format</span>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="darkMode" @click="actionHandler('darkMode')">
            <span class="material-icons">{{ controlState.darkMode ? 'light_mode' : 'dark_mode' }}</span>
            <div class="control-label"></div>
          </div>
          <div class="control-item" data-control="fullscreen" @click="actionHandler('fullscreen')">
            <span class="material-icons">{{ controlState.fullscreen ? 'close_fullscreen' : 'fullscreen' }}</span>
            <div class="control-label"></div>
          </div>

          <div class="control-panel play-panel" data-target-control="autoPlay" v-if="visiblePanel === 'autoPlay'">
            <div class="speed">
              <button class="material-icons speed-dec" data-action="dec" @click="changeAutoPlayDuration(settings.autoPlayDuration - 1)">
                remove
              </button>
              <span class="speed-value">{{ settings.autoPlayDuration }}</span>
              <button class="material-icons speed-inc" data-action="inc" @click="changeAutoPlayDuration(settings.autoPlayDuration + 1)">
                add
              </button>
            </div>
          </div>

          <div class="control-panel font-panel" data-target-control="font" v-if="visiblePanel === 'font'">
            <div class="font-family">
              <c-select :value="settings.fontFamily" @input="settings.fontFamily=$event">
                <template v-slot:label="{ label }">
                  <div class="font-family-label" :data-font="settings.fontFamily">{{ label }}</div>
                </template>
                <c-option value="SYST" data-font="SYST">思源宋体</c-option>
                <c-option value="FZSS" data-font="FZSS">方正书宋</c-option>
                <c-option value="FZFS" data-font="FZFS">方正仿宋</c-option>
                <c-option value="FZHT" data-font="FZHT">方正黑体</c-option>
                <c-option value="FZKT" data-font="FZKT">方正楷体</c-option>
                <c-option value="LXWK" data-font="LXWK">落霞文楷</c-option>
              </c-select>
              <span class="material-icons">chevron_right</span>
            </div>
            <div class="font-weight" :class="{ selected: settings.bold }" @click="settings.bold=!settings.bold">
              B
            </div>
            <div class="font-size">
              <button class="material-icons text-dec" @click="settings.fontSize -= 1">
                  text_decrease
              </button>
              <span class="text-size">{{ settings.fontSize }}</span>
              <button class="material-icons text-inc" @click="settings.fontSize += 1">
                  text_increase
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div class="catalog" :style="{ zIndex: visible ? 10 : -1}">
      <div class="mask" @click="$emit('close')"></div>
      <div class="catalog-content">
        <virtual-list
          class="catalog-content-wrapper"
          data-key="id"
          :data-sources="catalog"
          ref="catalog"
          :estimate-size="48">
          <template #="{ source, index }">
            <div class="catalog-item"
              @click="$emit('to-catalog-item', source, index)"
              :class="{active: selectedItem && `${source.id}` === `${selectedItem.id}`}"
              :data-catalog-id="source.id">
              <div class="catalog-label">{{ source.title }}</div>
            </div>
          </template>
        </virtual-list>
      </div>
    </div>

    <div class="c-dialog">
      <div class="mask" @click="$emit('close')"></div>
      <div class="c-dialog-content">
        <slot></slot>
      </div>
    </div>
  </div>
  <script async src="https://unpkg.com/es-module-shims@1.7.3/dist/es-module-shims.js"></script>
  <script src="./js/lib/vconsole.min.js"></script>
  <script src="./js/lib/zepto.min.js"></script>
  <script src="./js/lib/hammer.min.js"></script>
  <script type="importmap">
    { "imports": {
        "vue":               "https://unpkg.com/vue@3/dist/vue.esm-browser.js",
        "vue-router":        "https://unpkg.com/vue-router@4/dist/vue-router.esm-browser.js",
        "@vue/devtools-api": "https://unpkg.com/@vue/devtools-api@6.4.5/lib/esm/index.js"
    } }
  </script>
  <script type="module" src="./index.js"></script>
  <!-- <script type="module" src="./register-sw.js"></script> -->
</body>
</html>